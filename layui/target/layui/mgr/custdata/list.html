<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>客群数据管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="../../layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="../../layuiadmin/style/admin.css" media="all">

</head>

<body>
	<div class="layui-fluid">
		<div class="layui-card">
			<div class="layui-form layui-card-header layuiadmin-card-header-auto">
				<div class="layui-form-item">
					<div class="layui-inline">
						<label class="layui-form-label" style="width: 5vw;">客户姓名</label>
						<div class="layui-input-block" style="width: 8vw;">
							<input type="text" name="customerName" id="customerName" 
								autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-inline"><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p></div>
					<div class="layui-inline">
						<label class="layui-form-label" style="width: 5vw;">营业部</label>
						<div class="layui-input-block" style="width: 8vw;">
							<input type="text" name="businessDepartment" id="businessDepartment" 
								autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-inline"><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p></div>
					<div class="layui-inline">
						<label class="layui-form-label" style="width: 10vw;">司内资产范围</label>
					</div>
					<div class="layui-inline">
						<div  style="width: 8vw;">
							<input type="text" name="startInternalAssets" id="startInternalAssets"
								autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-inline"><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p></div>
					<div class="layui-inline">
						<div  style="width: 8vw;">
							<input type="text" name="endInternalAssets" id="endInternalAssets"
								autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-inline">
						<label class="layui-form-label" style="width: 10vw;">司外资产范围</label>
					</div>
					<div class="layui-inline">
						<div  style="width: 8vw;">
							<input type="text" name="startExtradivisionalAssets" id="startExtradivisionalAssets"
								autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-inline"><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p></div>
					<div class="layui-inline">
						<div  style="width: 8vw;">
							<input type="text" name="endExtradivisionalAssets" id="endExtradivisionalAssets"
								autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-inline">
						<label class="layui-form-label" style="width:15vw;">前次营销时间范围</label>
					</div>
					<div class="layui-inline">
						<div  style="width: 8vw;">
							<input type="text" name="startPreviousMarketingDate" id="startPreviousMarketingDate"
								autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-inline"><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p></div>
					<div class="layui-inline">
						<div  style="width: 8vw;">
							<input type="text" name="endPreviousMarketingDate" id="endPreviousMarketingDate"
								autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-inline">
						<label class="layui-form-label" style="width: 10vw;">下次营销时间范围</label>
					</div>
					<div class="layui-inline">
						<div  style="width: 8vw;">
							<input type="text" name="startNextMarketingDate" id="startNextMarketingDate"
								autocomplete="off" class="layui-input">
						</div>
					</div>
					<div class="layui-inline"><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</p></div>
					<div class="layui-inline">
						<div  style="width: 8vw;">
							<input type="text" name="endNextMarketingDate" id="endNextMarketingDate"
								autocomplete="off" class="layui-input">
						</div>
					</div>

					<div class="layui-inline">
						<label class="layui-form-label" ></label>
                        <button class="layui-btn layuiadmin-btn-admin" lay-submit lay-filter="LAY-customerData-back-search">
                            <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>
                        </button>
                    </div>
				</div>
			</div>

			<div class="layui-card-body">
				<div style="padding-bottom: 10px;">
					<button class="layui-btn layuiadmin-btn-admin" data-type="batchdel">批量删除</button>
					<button class="layui-btn layuiadmin-btn-admin" data-type="add"><i
                            class="layui-icon">&#xe654;</i>添加</button>
					<button class="layui-btn layuiadmin-btn-admin" data-type="btnExcel">导出</button>
					<button class="layui-btn layuiadmin-btn-admin" data-type="openUpLoad">导入</button>
				</div>

				<table id="LAY-customerData-back-manage" lay-filter="LAY-customerData-back-manage"></table>
				<script type="text/html" id="barDemo">
                    <a class="layui-btn layui-btn-normal layui-btn-xs" lay-event="edit"><i class="layui-icon layui-icon-edit"></i>编辑</a>
                    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del"><i class="layui-icon layui-icon-delete"></i>删除</a>
                  </script>
			</div>
		</div>
	</div>
	
	<script src="../../layuiadmin/layui/layui.js"></script>
    <script>
      	layui.config({
        	base: '../../layuiadmin/' //静态资源所在路径
      	}).extend({
        	index: 'lib/index' //主入口模块
      	}).use(['index', 'laydate'], function(){
        	var laydate = layui.laydate;
       
        	laydate.render({
          		elem: '#startPreviousMarketingDate',
          		trigger: 'click'
        	});
        	laydate.render({
          		elem: '#endPreviousMarketingDate',
          		trigger: 'click'
        	});
        	laydate.render({
          		elem: '#startNextMarketingDate',
          		trigger: 'click'
        	});
        	laydate.render({
          		elem: '#endNextMarketingDate',
          		trigger: 'click'
        	});
      	});
        
        layui.config({
            base: '../../layuiadmin/' //静态资源所在路径
        }).extend({
            index: 'lib/index' //主入口模块
        }).use(['index', 'table', '_customerData'], function () {
            var $ = layui.$
                , form = layui.form
                , table = layui.table;

            //监听搜索
            form.on('submit(LAY-customerData-back-search)', function (data) {
                var field = data.field;

                //执行重载
                table.reload('LAY-customerData-back-manage', {
                    where: field
                });
            });

            //事件
            var active = {
                batchdel: function () {
                    var checkStatus = table.checkStatus('LAY-customerData-back-manage')
                        , checkData = checkStatus.data
                        , icustomerDatas = []
                        , icustomerData = {}; //得到选中的数据

                    if (checkData.length === 0) {
                        return layer.msg('请选择数据');
                    }

                    checkData.forEach(function (element) {
                    	icustomerData = {
                            icustomerData: element.icustomerData
                        }
                        icustomerDatas.push(icustomerData);
                    });

                    if (icustomerDatas.length != 0) {
                        layer.confirm('确定删除？', function (index) {
                            $.ajax({
                                url: 'batchDelete.ajax',
                                type: 'post', //如果无需自定义HTTP类型，可不加该参数
                                dataType: "json",
                                data: {
                                    json: JSON.stringify(icustomerDatas)
                                },
                                success: function (res) {
                                    if (res.code == 0) {
                                        layer.alert("删除成功");
                                        table.reload("LAY-customerData-back-manage");
                                    } else {
                                        layer.alert("由于未知错误，删除失败，请稍后重试");
                                    }
                                }
                            });
                            layer.close(index);

                        });
                    }
                }
                , add: function () {
                    layer.open({
                        type: 2
                        , title: '添加客群数据'
                        , content: './add.html'
                        , area: ['1100px', '500px']
                        , btn: ['确定', '取消']
                        , yes: function (index, layero) {
                            var iframeWindow = window['layui-layer-iframe' + index]
                                , submitID = 'LAY-customerData-back-submit'
                                , submit = layero.find('iframe').contents().find('#' + submitID);
                            //监听提交
                            iframeWindow.layui.form.on('submit(' + submitID + ')', function (data) {
                                var field = data.field; //获取提交的字段
                                //提交 Ajax 成功后，更新表格中的数据
                                //$.ajax({});
                                $.ajax({
                                    type: "POST",
                                    url: "add.ajax",
                                    data: field,
                                    dataType: "json",
                                    success: function (msg) {
                                        if (msg.code == "0") {
                                            layer.alert("增加成功", {
                                                icon: 6
                                            });
                                        } else if (msg.code == "-2") {
                                            layer.alert(msg.verify, {
                                                icon: 6
                                            });
                                        }
                                    },
                                    error: function () {
                                        layer.alert("增加失败!", {
                                            icon: 6
                                        });
                                    }
                                });
                                table.reload('LAY-customerData-back-manage'); //数据刷新
                                layer.close(index); //关闭弹层
                            });

                            submit.trigger('click');
                        }
                    });
                }
                , openUpLoad: function () {
                	layer.open({
    					type : 2,
    					content: './upload.html',
    					btn : [ '确定', '取消' ],
    					area : [ '600px', '300px' ],
    					offset : '10px',
    					title : '导入文件',
    					shade : 0.6, //遮罩透明度
    					maxmin : true, //允许全屏最小化
    					anim : 2,//0-6的动画形式，-1不开启
    					success : function(layero, index) {
    						body = layer.getChildFrame('body', index);
    					},
    					yes : function(layero, index) {
    						body.find("#onc").click();
    						//alert(body.find("#upLoad"));
    					},
    					btn2 : function(layero, index) {
    						layer.closeAll();
    					},
    					end : function() {
    						tableIns.reload({
    							page : {
    								curr : 1,
    							},
    							where: {
    								customerName: $('#customerName').val(),
    								businessDepartment: $('#businessDepartment').val(),
    								startInternalAssets: $('#startInternalAssets').val(),
    								endInternalAssets: $('#endInternalAssets').val(),
    								startExtradivisionalAssets: $('#startExtradivisionalAssets').val(),
    								endExtradivisionalAssets: $('#endExtradivisionalAssets').val(),
    								startPreviousMarketingDate: $('#startPreviousMarketingDate').val(),
    								endPreviousMarketingDate: $('#endPreviousMarketingDate').val(),
    								startNextMarketingDate: $('#startNextMarketingDate').val(),
    								endNextMarketingDate: $('#endNextMarketingDate').val()
    							},
    						});
    						return false;
    					}
                	})
                }
                , btnExcel:function () {
                	var $customerName = $("#customerName").val();
        			var $businessDepartment = $("#businessDepartment").val();
        			var $startInternalAssets = $("#startInternalAssets").val();
        			var $endInternalAssets = $("#endInternalAssets").val();
        			var $startExtradivisionalAssets = $("#startExtradivisionalAssets").val();
        			var $endExtradivisionalAssets = $("#endExtradivisionalAssets").val();
        			var $startPreviousMarketingDate = $("#startPreviousMarketingDate").val();
        			var $endPreviousMarketingDate = $("#endPreviousMarketingDate").val();
        			var $startNextMarketingDate = $("#startNextMarketingDate").val();
        			var $endNextMarketingDate = $("#endNextMarketingDate").val();
        			$.ajax({
        				type:"post",
        				url:"confirmCustomerData_excel.ajax",
        				async:true,
        				data: {
        					customerName: $customerName,
        					businessDepartment: $businessDepartment,
        					startInternalAssets: $startInternalAssets,
        					endInternalAssets: $endInternalAssets,
        					startExtradivisionalAssets: $startExtradivisionalAssets,
        					endExtradivisionalAssets: $endExtradivisionalAssets,
        					startPreviousMarketingDate: $startPreviousMarketingDate,
        					endPreviousMarketingDate: $endPreviousMarketingDate,
        					startNextMarketingDate: $startNextMarketingDate,
        					endNextMarketingDate: $endNextMarketingDate
        				},
        				dataType: "json",
        				success: function (respData) {
        					layer.alert('导出'+respData.data.length+'条记录，并保存为excel表格，请确认是否导出？', {
        						 skin: 'layui-layer-molv' ,
        						 closeBtn: 1,
        						 anim: 1 ,//动画类型
        						 btn: ['确定','取消'],
        						 icon: 6,
        						 yes:function(){
        							 $.ajax({
        									type:"post",
        									url:"customerData_excel.ajax",
        									async:true,
        									data: {
        										customerName: $customerName,
        										businessDepartment: $businessDepartment,
        										startInternalAssets: $startInternalAssets,
        										endInternalAssets: $endInternalAssets,
        										startExtradivisionalAssets: $startExtradivisionalAssets,
        										endExtradivisionalAssets: $endExtradivisionalAssets,
        										startPreviousMarketingDate: $startPreviousMarketingDate,
        										endPreviousMarketingDate: $endPreviousMarketingDate,
        										startNextMarketingDate: $startNextMarketingDate,
        										endNextMarketingDate: $endNextMarketingDate
        									},
        									dataType: "json",
        									success: function (respData) {
        										if (respData.data.length == 0) {
        											layer.alert("无信息可导出");
        											return;
        										}
        										var fileName = "客群数据";
        										if ($customerName != "" || $businessDepartment != "" || $startInternalAssets != "" || $endInternalAssets != ""|| $startExtradivisionalAssets != "" || $endExtradivisionalAssets != ""|| $startPreviousMarketingDate != "" || $endPreviousMarketingDate != ""|| $startNextMarketingDate != "" || $endNextMarketingDate != "") {
        											fileName += "(";
        											if ($customerName != "") {
        												fileName += "客户姓名中含有：" + $customerName + "，";
        											}
        											if ($businessDepartment != "") {
        												fileName += "营业部中含有：" + $businessDepartment + "，";
        											}
        											if ($startInternalAssets != "" && $endInternalAssets != "") {
        												fileName += "司内资产：" + $startInternalAssets + "至" + $endInternalAssets + "，";
        											} else if ($startInternalAssets != "") {
        												fileName += "司内资产大于" + $startInternalAssets +"，";
        											} else if ($endInternalAssets != "") {
        												fileName += "司内资产小于" + $endInternalAssets + "，";
        											}
        											if ($startExtradivisionalAssets != "" && $endExtradivisionalAssets != "") {
        												fileName += "司外资产：" + $startExtradivisionalAssets + "至" + $endExtradivisionalAssets + "，";
        											} else if ($startExtradivisionalAssets != "") {
        												fileName += "司外资产大于" + $startExtradivisionalAssets  + "，";
        											} else if ($endExtradivisionalAssets != "") {
        												fileName += "司外资产小于" + $endExtradivisionalAssets + "，";
        											}
        											if ($startPreviousMarketingDate != "" && $endPreviousMarketingDate != "") {
        												fileName += "前次营销时间：" + $startPreviousMarketingDate + "至" + $endPreviousMarketingDate + "，";
        											} else if ($startPreviousMarketingDate != "") {
        												fileName += "前次营销时间晚于" + $startPreviousMarketingDate + "，";
        											} else if ($endPreviousMarketingDate != "") {
        												fileName += "前次营销时间早于" + $endPreviousMarketingDate + "，";
        											}
        											if ($startNextMarketingDate != "" && $endNextMarketingDate != "") {
        												fileName += "下次营销时间：" + $startNextMarketingDate + "至" + $endNextMarketingDate + "，";
        											} else if ($startNextMarketingDate != "") {
        												fileName += "下次营销时间晚于" + $startNextMarketingDate + "，";
        											} else if ($endNextMarketingDate != "") {
        												fileName += "下次营销时间早于" + $endNextMarketingDate + "，";
        											}
        											fileName = fileName.substr(0, fileName.length - 1);
        											fileName += ")";
        										}
        										var sheetName = "客群数据列表";
        										var titles = [{icustomerData:'主键'},{customerName: '客户姓名'}, {businessDepartment: '营业部'}, {capitalAccount: '资金账号'}, {gender: '性别'},{yearOfBirth: '出生年份'},{occupation: '职业'},{accountOpeningDate: '开户时间'},{internalAssets: '司内资产'}, {extradivisionalAssets: '司外资产'}, {internalAssetsType:'司内资产类别'},{userProtrait:'用户画像'},{investmentPreference:'投资偏好'},{liquidityRequirements:'流动性要求'},{externalResources:'外部资源'},{otherRemarks:'其他备注'},{childrenSituation:'子女情况'},{childrenAge:'子女年龄'},{previousMarketingContent:'前次营销内容'},{previousMarketingDate: '前次营销时间'},{customerFeedback: '客户反馈及需求'},{nextMarketingTarget: '下次营销目标'},{nextMarketingDate: '下次营销时间'},{marketingContent: '营销内容'}];
         										toExcel(fileName, sheetName, respData.data, titles, "", "");
        		
        									},
        									error: function (err) {
        										layer.alert("导出失败！");
        									}
        								});
        							 	layer.alert("导出成功，共导出"+respData.data.length+"条数据！")
        						 },
        						 btn2:function(){
        							 parent.layer.close();
        						 }
        					});
        					
        				},
        				error: function (err) {
        					layer.alert("导出失败！");
        				}
        			});
                }
            }
            $('.layui-btn.layuiadmin-btn-admin').on('click', function () {
                var type = $(this).data('type');
                active[type] ? active[type].call(this) : '';
            });
        });
        
      //param:excel文件名，工作簿名，导出的数据集合，字段名集合，表头样式，表体样式
        function toExcel(FileName, SheetName, JSONData, ShowLabel, StyleThead, StyleTbody) {  
            //先转化json  
            var arrData = typeof JSONData != 'object' ? JSON.parse(JSONData) : JSONData;  
              
            var excel = '<table>';      
              
            if (ShowLabel[0][0] == null) {
            	//设置表头  
            	var row = "<tr align='center'>";//设置Excel的左居中
        	    for (var i = 0, l = ShowLabel.length; i < l; i++) {  
        	        for (var key in ShowLabel[i]) {
        	            row += "<td style='" + StyleThead + "'>" + ShowLabel[i][key] + '</td>';  
        	        }
        	    }
        	    //换行  
        	    excel += row + "</tr>";
            	//设置数据  
        	    for (var i = 0; i < arrData.length; i++) {
            		var rowData = "<tr align='center'>";
            		var tdData = showData(i, ShowLabel, arrData, StyleTbody);
            		excel += rowData + tdData + "</tr>";
            	}
            } else {
            	//设置表头  
            	var tableTitle = "<tr align='center'>";
            	tableTitle += "<td colspan='" + (ShowLabel[1].length + 1)  + "' style='font-size:20px;font-weight:bold;text-align:center;'>" + ShowLabel[0][0] + '</td>';
            	excel += tableTitle + "</tr>";
            	var row = "<tr align='center'>";//设置Excel的左居中
        	    row += "<td rowspan='2' style='" + StyleThead + "'></td>";
        	    for (var i = 0, l = ShowLabel[1].length; i < l; i++) {  
        	        for (var key in ShowLabel[1][i]) {
        	            row += "<td rowspan='2' style='" + StyleThead + "'>" + ShowLabel[1][i][key] + '</td>';  
        	        }
        	    }
        	    //换行  
        	    excel += row + "</tr><tr></tr>";
            	//设置数据  
            	for (var i = 0; i < arrData.length; i++) {
            		var rowData = "<tr align='center'>";
            		rowData += "<td style='vnd.ms-excel.numberformat:@;" + StyleTbody + "'>" + (i + 1) + "</td>";
            		var tdData = showData(i, ShowLabel[1], arrData, StyleTbody);
            		excel += rowData + tdData + "</tr>";
            	}
            }

            excel += "</table>";  

            var excelFile = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:x='urn:schemas-microsoft-com:office:excel' xmlns='http://www.w3.org/TR/REC-html40'>";  
            excelFile += '<meta http-equiv="content-type" content="application/vnd.ms-excel; charset=UTF-8">';  
            excelFile += '<meta http-equiv="content-type" content="application/vnd.ms-excel';  
            excelFile += '; charset=UTF-8">';  
            excelFile += "<head>";  
            excelFile += "<!--[if gte mso 9]>";  
            excelFile += "<xml>";  
            excelFile += "<x:ExcelWorkbook>";  
            excelFile += "<x:ExcelWorksheets>";  
            excelFile += "<x:ExcelWorksheet>";  
            excelFile += "<x:Name>";  
            excelFile += SheetName;  
            excelFile += "</x:Name>";  
            excelFile += "<x:WorksheetOptions>";  
         	excelFile += "<x:DisplayGridlines/>";
            excelFile += "</x:WorksheetOptions>";  
            excelFile += "</x:ExcelWorksheet>";  
            excelFile += "</x:ExcelWorksheets>";  
            excelFile += "</x:ExcelWorkbook>";  
            excelFile += "</xml>";  
            excelFile += "<![endif]-->";  
            excelFile += "</head>";  
            excelFile += "<body>";  
            excelFile += excel;  
            excelFile += "</body>";  
            excelFile += "</html>";  

              
            var uri = 'data:application/vnd.ms-excel;charset=utf-8,' + encodeURIComponent(excelFile);  
              
            var link = document.createElement("a");
            link.href = uri;  
              
            link.style = "visibility:hidden";  
            link.download = FileName + ".xls";  
              
            document.body.appendChild(link);  
            link.click();  
            document.body.removeChild(link);  
        }
        function showData(i, ShowLabel, arrData, StyleTbody) {
        	var rowData = "";
        		
            for (var y = 0; y < ShowLabel.length; y++) {
                for(var k in ShowLabel[y]){
                    if (ShowLabel[y].hasOwnProperty(k)) {
                    	rowData += "<td style='vnd.ms-excel.numberformat:@;" + StyleTbody + "'>";
                    	if (arrData[i][k]===null) {
                    		//值为空
                    		rowData += "";
                    	} else if ((typeof arrData[i][k]) == 'object') {
                    		//值为时间对象
                    		var time = arrData[i][k];
                    		rowData += (time.year + 1900) + "年" + (time.month + 1) + "月" + time.date + "日";
                    	} else if (k == "sex") {
                    		//性别
                    		if (arrData[i][k] == 1) {
                    			rowData += "男";
                    		} else {
                    			rowData += "女";
                    		}
                    	} else {
                    		rowData += arrData[i][k];
                    	}
                    	if (k == "schedule") {
                    		//需要加上百分比的字段
                    		rowData += "%";
                    	}
                    	rowData += "</td>";
         //vnd.ms-excel.numberformat:@ 输出为文本
                    }
                }
            }
            return rowData;
        }

    </script>
</body>

</html>